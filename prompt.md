我的油猴脚本需求如下：
编程风格：

1. 使用面向对象的风格
2. 把js作为函数写在油猴脚本中，然后组装的时候用fun1.toString()方式把源码注入到html字符串中，然后把html放到新页面。
3. 用传统的function模拟对象，这样可以简化html嵌入js的难度。类似 `function ClassA{ this.prop = xxx; this.method=function(){}; }`，不要用prototype链。

名词定义：

* 主窗口：包含多个ai对话内容的页面，该窗口名字为multi-ai-sync-chat-window
* ai对话页面：也叫做原生页面，是浏览器中输入url访问到的ai服务提供商的对话页面
* ai会话：在ai对话页面中进行人机对话的所有问答内容
* 内容块：也叫chatarea，是主窗口中存放每一个ai会话内容的区域，该区域包含一些对ai对话页面的控制部件

基础逻辑：
1. 每个ai对话页面都会注入一个“同步对比”的按钮，点击之后会打开主窗口，并在主窗口里面做各个ai会话内容的对比
2. 每个ai对话页面都通过通讯机制和ai会话内容进行内容同步
3. 主窗口中填入的提示词内容会通过通讯机制放到每个ai对话页面的文字输入框中，并且发送

类结构定义：

* SyncChatWindow对象：负责管理主窗口逻辑，以及和窗口中多个ai聊天页面通讯和控制
* ChatArea对象：负责ai会话内容块的初始化和管理一个ai的聊天页面和通讯
* InjectionController：负责嵌入到ai对话页面里，挂接ai原生聊天页面的各种部件，并接收通讯消息去控制原生页面
* MessageNotifier：负责在主窗口、chatarea和ai对话页面之间的通讯，利用BroadcastChannel API和Window.postMessage机制


通讯消息定义：

* create：原生窗口通知主窗口创建一个内容块，携带参数url为原生窗口的url，tabId为浏览器为原生窗口赋予的唯一名称，config为一个json，包含各种配置按钮的状态
* chat：主窗口通知原生窗口增加一个问题，携带参数为message包含用户输入的文字
* config：主窗口通知原生窗口设置各种配置按钮的状态，携带参数为配置按钮名词和bool类型的开关值
* thread：主窗口通知原生窗口创建一个新会话，结束当前会话

功能定义：
1. 功能入口注入
     1. 脚本延迟3秒检测并在页面中增加“同步对比”按钮，页面包括www.kimi.com/chat/，https://gemini.google.com/，https://chatgpt.com/，https://chat.deepseek.com/，https://x.com/i/grok，https://www.tongyi.com/
     2. 同步对比按钮点击之后，检测主窗口，如果不存在则创建，否则获取主窗口，然后把当前url作为`create`消息的参数发给他
2. 主窗口逻辑
     1. 主窗口布局从上到下为：
     
          * 顶部标题栏：内部从左到右为标题“多个AI同步聊天”，然后是居中的布局按钮组可以切换1、2、3、4、6个内容块的布局，然后是居右的新对话按钮。
            最底下是提示词栏，从左到右包含一个文本输入框，可以输入聊天的提示词，输入框右侧是一个发送按钮。
          * 主内容区域：填充窗口剩余部分，根据布局排列div，每个div可以放入一个chatarea。
     2. 内容块的创建：当收到带url的消息之后，会在把当前布局切换到下一个更多内容块的布局，并且增加一个新的内容块。区域负责创建chatarea对象。
     3. 提示词发送逻辑：提示词栏的文本在点击发送按钮之后，会发送`chat`消息到所有内容块的chatarea，然后由chatarea对象和原生页面同步。
3. 内容块逻辑
     1. 内容块创建：接收窗口消息来创建内容块的时候，需要传入布局元素的div的id，然后在这个id下创建内容块的布局，
     2. 内容块布局包括如下：
     
          * 区域顶部标题：从左到右包含：
            * ai名称，左对齐，可下拉列表中切换ai，新ai的区域会替换当前区域的位置，如果当前内容块已经有内容变化，则提示是否切换，确认要切换之后再切换。提示框用自制的非阻塞弹出框。
            * web检索标志开关，跟ai名称在同一组都是左对齐，点击之后会发送`config`消息给chatarea页面，切换里的检索标志开关（如果有的话），
            * 分享标志，跟关闭对话框同一组，都是右对齐，点击之后发送`share`消息给chatarea页面，模拟点击分享按钮
            * 独立窗口打开标志，跟关闭对话框按钮在同一组，都是右对齐，点击之后在新窗口中打开chatarea的url，但是如果已经有原生窗口了，就激活原生窗口。内容块保持不变。
            * 关闭内容块标志，右对齐，在最右边，点击之后关闭当前内容块
          * 区域底部隐藏的输入框（鼠标浮动出现浮动的向上箭头，不影响页面其他布局，点击之后才出现输入框，输入后回车就发送消息到原生页面），
          * 区域内容：填充区域剩余部分，并展示原生页面抓取的对话内容，根据`create`消息中包含的url来判断是哪一种ai页面。
     
     3. 内容块chatarea内的事件响应：`chat`消息，负责将消息文本填充到原生页面的对话输入框中并模拟点击发送；`share`消息，模拟点击原生页面中的共享按钮生成会话共享链接；`thread`消息，负责模拟点击原生页面新对话按钮创建新对话；`config`消息，携带配置名称和开关状态，负责模拟点击各种配置按钮
4. 原生页面的注入控制
    1. 我们把url对应页面叫做原生页面，对不同的ai页面使用对应ai类型的策略模式来创建。策略把页面内容的元素进行关联，并加入对应的通讯事件响应逻辑
    2. 对原生页面的修改：策略对每一次对话的回复内容做一个悬浮工具条，允许用户copy、折叠、展开、隐藏这一条对话。

