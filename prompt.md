# 提示词

你现在是油猴脚本编写专家，我的油猴脚本作者为jiangjianbo，项目url为https://github.com/jiangjianbo/multi-ai-chat-userscript。其他功能需求如下：

## 编程风格：

1. 使用面向对象的风格
2. 生成的对象方法代码要有方法java doc风格的注释，包括方法体、参数、返回值的说明
3. 类的变量名称要避免使用window这种关键字
4. 把js作为函数写在油猴脚本中，然后组装的时候用fun1.toString()方式把源码注入到html字符串中，然后把html放到新页面。
5. 用传统的function模拟对象，这样可以简化html嵌入js的难度。类似 `function ClassA{ this.prop = xxx; this.method=function(){}; }`，所有成员函数都用 this.method = function的方式。
6. 要嵌入的html内容用常量字符串存放，不要在代码中到处随意嵌入，常量也尽量放到类中。
7. 尤其注意用反引号(`)包含的文本块内容，千万不要嵌套使用。
9. 要注意一些嵌入到html中的脚本会引用其他的对象，要把这些对象的源代码也用toString的方式加入到html中

## 第一阶段，创建基本的油猴脚本框架

### 名词定义

* ai对话页面：也叫做原生页面，是浏览器中输入url访问到的ai服务提供商的对话页面
* ai会话：在ai对话页面中进行人机对话的所有问答内容

### 基础逻辑

1. 油猴脚本中包含功能：原生页面驱动。
2. 每个原生页面即ai对话页面都会注入一个“同步对比”的按钮，点击之后会输出一个log信息

### 插件详细逻辑

1. 插件启动，等待3秒之后，开始执行main函数中的主逻辑代码
   1. 先给当前所在的ai对话页面（即原生页面）添加“同步对比”按钮

### 类结构定义

* InjectionController：负责嵌入到ai对话页面即原生页面里

### 功能定义

1. 功能入口注入
     1. 脚本延迟3秒检测并在页面中增加“同步对比”按钮，默认支持的ai提供商包括如下6个：www.kimi.com/chat/，https://gemini.google.com/，https://chatgpt.com/，https://chat.deepseek.com/，https://x.com/i/grok，https://www.tongyi.com/，如果localstorage中非空至少有一个网址则优先使用并忽略默认值。
     2. 同步对比按钮点击之后，输出log信息。

## 注意事项

* 可以用jquery风格的辅助函数，放到Utils类里面，简化一些选择器和繁琐的功能调用
* 使用Promise简化异步处理
* 不要在生成的 反引号（`）包括的文字块中继续生成嵌套的反引号内容，请提取成变量再进行嵌入。尤其在SyncChatWindow中，如果要嵌入代码请使用 function 的 toString 方法嵌入源码到html中。
* 默认的AI供应商列表提取到常量数组里，不要重复出现。同时要举一反三，注意其他类似可以提取为公共变量的重复内容现象。

## 第二阶段，适配原生页面

### 插件详细逻辑

1. 插件启动，等待3秒之后，开始执行main函数中的主逻辑代码
   1. 先给当前所在的ai对话页面（即原生页面）添加“同步对比”按钮
   2. 为当前页面创建一个InjectionController，并选择合适的Driver
   3. 扫描当前页面中的对话内容，为对话内容添加快捷工具条

### 类结构定义

* InjectionController：负责嵌入到ai对话页面即原生页面里，挂接ai原生聊天页面的各种部件（包括文字输入框，对话内容区，历史对话区），并接收通讯消息去控制原生页面（包括复制、隐藏、折叠、展开原生回答的内容等）
* XxxPageDriver：原生页面的驱动策略实现，其中Xxx用AI供应商的名称替代。负责提供统一的api接口，实现登录用户名的获取、会话历史清单的获取、对话输入框内容的发送、回答内容的获取、回答完成后产生通知、问题和回答内容上浮动工具栏的实现。通用页面策略GenericPageDriver提供基础的操作，其他页面驱动类都从它派生

### 功能定义

1. 原生页面的注入控制
    1. 我们把url对应页面叫做原生页面，原生页面由对应的ai提供商开发，本脚本使用对应名字的策略模式来对接。策略负责把页面内容的元素进行关联，并提供统一的api接口，简化InjectionController的开发难度
    2. 对原生页面的修改：策略对每一次对话的回复内容做一个悬浮工具条，允许用户copy、折叠、展开、隐藏这一条问题或回答。

### 注意事项

* 内容块的切换ai一定要记得让用户确认
* ai名称切换之后在该区域中显示的非阻塞对话框需要用回调函数才能正确响应，不能用if(confirm(...)) { doAction... } 这种模式。
* 在默认的通用页面策略GenericPageDriver中，把选择器单独存放在类中，允许派生类去复用代码和修改选择器


## 第三阶段，主窗口逻辑

### 名词定义

* 主窗口：包含多个ai对话内容的页面，该窗口名字为multi-ai-sync-chat-window
* 内容块：也叫chatarea，是主窗口中存放每一个ai会话内容的区域，该区域包含一些对ai对话页面的控制部件

### 基础逻辑

1. 油猴脚本中包含两类功能：原生页面驱动，以及主窗口驱动。
2. 每个原生页面即ai对话页面都会注入一个“同步对比”的按钮，点击之后会打开主窗口，并在主窗口里面做各个ai会话内容的对比

### 插件详细逻辑

1. 等待“同步对比”按钮被点击
   1. 检查主窗口是否存在，如果没有则创建
   2. 通知主窗口添加本页面的内容到内容块，如果已经有相同网址的内容块则覆盖之前的会话

### 类结构定义

* SyncChatWindow对象：负责管理主窗口逻辑，含历史信息展示和对话输入框以及嵌入的多个ai聊天页面内容块（ChatArea对象）的通讯和控制。每个AI提供商网址只能有一个会话内容块
* ChatArea对象：负责某个特定的ai会话内容块的初始化
* SyncChatWindowContent：负责主窗口的html和相关script的生成，由SyncChatWindow调用

### 功能定义

1. 主窗口逻辑
     1. 主窗口为独立的tab页（浏览器支持tab页）或新正常浏览窗口（浏览器不支持tab页），布局从上到下为：
          * 顶部标题栏：内部从左到右为标题“多个AI同步聊天”，标题后紧跟多语言切换下拉框（用地球icon表示，点击下拉之后对应激活语言前有打勾），然后是居中的布局按钮组可以切换1、2、3、4、6个内容块的布局（最好能有icon表示这些布局，布局1和2和3为单行多列，4为2行2列，6为2行3列），然后是居右的按钮组，组内从左到右是配置按钮和新对话按钮。这些按钮都最好用icon表示，鼠标浮动上去才显示按钮名称。
          * 最底下是提示词栏，从左到右包含一个文本输入框，可以输入聊天的提示词，输入框右侧是一个发送按钮。其中发送按钮是固定宽度，剩余的宽度被文本输入框填充（支持跟随窗口宽度的变化）。
          * 主内容区域：填充窗口剩余部分，根据布局排列div，每个div可以放入一个chatarea。
          * 配置窗口：配置按钮点击出现配置窗口，用来配置ai提供商的名称和网址，默认包含刚才说的6个提供商，所有提供商都存储在local storage中。配置窗口中有一个装入默认值的按钮，负责装入默认的ai提供商清单。
     2. 内容块的创建：新增加一个内容块，会在把当前布局切换到下一个更多内容块的布局，并且创建chatarea对象。
2. 内容块逻辑
     1. 内容块布局包括如下：
          * 区域顶部标题：从左到右包含：
            * ai名称，左对齐，可下拉列表中切换ai，新ai的区域会替换当前区域的位置，如果当前内容块已经有内容变化，则提示是否切换，用户确认要切换之后再切换。提示框用自制的非阻塞弹出框，且仅显示在区域里。如果ai名称没有对应的原生窗口，则自动在后台打开一个。
            * web检索标志开关，跟ai名称在同一组都是左对齐，点击之后会切换里的检索标志开关（如果有的话），
            * 分享标志，跟关闭对话框同一组，都是右对齐，点击之后显示分享的链接。
            * 独立窗口打开标志，跟关闭对话框按钮在同一组，都是右对齐，点击之后在新窗口中打开chatarea的url，但是如果已经有原生窗口了，就激活原生窗口。
            * 关闭内容块标志，右对齐，在最右边，点击之后关闭当前内容块，但影响对应的原生窗口
          * 区域底部隐藏的专用输入框，鼠标移动到区域内则浮动出现向上箭头，不影响区域其他元素布局，点击箭头之后才出现浮动专用输入框，输入后回车就发送消息到原生页面，然后输入框焦点消失的话就自动隐藏，等到鼠标移入区域显示向上箭头。
          * 区域内容：填充区域剩余部分，并展示原生页面发送消息过来的对话内容。
  
### 注意事项

* 不要在生成的 反引号（`）包括的文字块中继续生成嵌套的反引号内容，请提取成变量再进行嵌入。尤其在SyncChatWindow中，如果要嵌入代码请使用 function 的 toString 方法嵌入源码到html中。


## 第四阶段，主窗口和原生页面的交互

### 基础逻辑：

1. 每个ai对话页面都通过通讯机制和ai会话内容进行内容同步
2. 主窗口中填入的提示词内容会通过通讯机制放到每个ai对话页面的文字输入框中，并且自动发送
3. 主窗口可以通过通讯机制调用原生页面的历史内容列表，并将其记录到自己的localstorage中，以便以后读取

### 插件详细逻辑

1. 原生页面根据事件消息和主窗口通讯

### 类结构定义

* ChatArea对象：负责某个特定的ai会话内容块的初始化，并管理与ai的聊天页面内容和通讯
* MessageNotifier：负责在主窗口、chatarea和ai对话页面之间的通讯，利用BroadcastChannel API和Window.postMessage机制

### 通讯消息定义：

* create：原生窗口通知主窗口创建一个内容块，携带参数url为原生窗口的url，tabId为浏览器为原生窗口赋予的唯一名称，config为一个json，包含原生窗口中各种配置按钮的状态：登录用户名、联网模式、模型选择、长思考，以及其他ai专有的状态（如grok的X搜索开关等）
* chat：主窗口通知原生窗口增加一个问题，携带参数为chatId表示问题的编号，message包含用户输入的文字，原生窗口收到之后往输入内容区填写文字并模拟点击发送按钮。在接收到ai的回答之后，会产生answer消息发回给主窗口。
* answer：原生窗口通知主窗口有回答了，携带参数包括url、tabId、chatId，answerTime为回复日期时间，answer为回答的innerhtml内容
* config：主窗口通知原生窗口设置各种配置按钮的状态，携带参数为配置按钮名词和bool类型的开关值，参考create的config说明
* thread：主窗口通知原生窗口结束当前会话，并创建一个新会话。创建新会话之后会反向发送一个thread_return消息
* thread_return：原生窗口通知主窗口一个新会话创建完毕，参数跟create消息相同
* share：主窗口通知原生窗口创建一个对话信息的share链接，携带消息为chatId的数组。根据不同ai提供商的特性，可以执行整个会话共享、选择对话共享、如果只有一个chatId则单个对话共享等
* share_return：原生窗口通知主窗口

因为我不清楚MessageNotifier封装之后是否能够支持消息携带异步返回消息，如果能够支持的话，就将chat和answer合并，thread、share跟各自的return消息合并。

### 功能定义：

1. 同步对比按钮点击之后，检测主窗口，如果不存在则创建，否则获取主窗口，然后把当前url作为`create`消息的参数发给他。
2. 主窗口逻辑
     1. 内容块的创建：当收到带url的create消息之后。
     2. 提示词发送逻辑：提示词栏的文本在点击发送按钮之后，会发送`chat`消息到所有内容块的chatarea，然后由chatarea对象和原生页面同步。
     3. 提示词同步逻辑：只有在主窗口中发送的信息的回复内容才会记录在主窗口（含提示词栏和专用输入框），在原生窗口中输入的内容因为不带chatId所以不会产生answer_return消息，因此会被主窗口忽略。
3. 内容块逻辑
     1. 内容块创建：接收原生窗口create消息来创建内容块的时候，需要传入布局元素的div的id，然后在这个id下创建内容块的布局，
     2. 内容块消息包括如下：
         * web检索标志开关，点击之后会发送`config`消息给chatarea页面，
         * 分享标志，点击之后发送`share`消息给chatarea页面，模拟点击分享按钮，且只能分享url，不支持其他形式分享，而且只能分享本区域的全部对话，不支持选择某个回答。
     3. 内容块chatarea内的事件响应：`chat`消息，负责将消息文本填充到原生页面的对话输入框中并模拟点击发送；`share`消息，模拟点击原生页面中的共享按钮生成会话共享链接；`thread`消息，负责模拟点击原生页面新对话按钮创建新对话；`config`消息，携带配置名称和开关状态，负责模拟点击各种配置按钮

### 注意事项

* 响应通讯消息的对象成员函数用onMsg前缀开头，每个对象在构造时候自动遍历成员函数进行自动注册。例如this.onMsgChat函数会自动注册为消息chat的回调，this.onMsgConfig则注册为config消息的回调。


## 第五阶段：国际化阶段

默认支持多语言，包括英语、中文、法语、日语、朝鲜语、西班牙语、葡萄牙语、阿拉伯语，根据浏览器当前语言切换，要注意阿拉伯语的从右向左的写作方式的支持。
