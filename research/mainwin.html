<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main Window Layout Demo (Final)</title>
    <style>
        body { margin:0; padding:0; font-family:Arial, sans-serif; background-color:#f0f2f5; color:#333; }
        .header { display:flex; justify-content:space-between; align-items:center; padding:10px 20px; background-color:white; border-bottom:1px solid #ddd; }
        .title { font-size:1.3rem; font-weight:bold; }
        .layout-buttons button { margin:0 5px; padding:8px 12px; border:1px solid #ccc; border-radius:4px; background-color:#fff; cursor:pointer; }
        .layout-buttons button.active { background-color:#007bff; color:white; border-color:#007bff; }
        .layout-buttons button:disabled { background-color:#e9ecef; cursor:not-allowed; opacity:0.6; }
        .control-buttons button { margin:0 5px; padding:8px 12px; border:none; background:none; font-size:1.5rem; cursor:pointer; }
        .chat-areas { display:grid; grid-template-columns:repeat(2, 1fr); gap:15px; padding:15px; height:calc(100vh - 140px); box-sizing:border-box; overflow-y: auto;}
        .chatarea { border:1px solid #ccc; border-radius:8px; display:flex; flex-direction:column; background-color:white; min-height: 300px; overflow: hidden;}
        .chatarea-header { padding:10px; background:#f7f7f7; border-bottom:1px solid #ddd; display:flex; justify-content:space-between; align-items:center; font-weight:bold; }
        .chatarea-body { position: relative; flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .chatarea-content { flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap: 10px; min-height: 0;}
        .main-input { display:flex; padding:15px; border-top:1px solid #ddd; background-color:white; }
        .main-input textarea { flex:1; padding:10px; border:1px solid #ccc; border-radius:4px; resize:none; }
        .main-input button { margin-left:10px; padding:10px 20px; border:none; border-radius:4px; background-color:#007bff; color:white; cursor:pointer; }
        .message { padding: 8px 12px; border-radius: 12px; max-width: 80%; word-wrap: break-word; }
        .message.user { background-color: #dcf8c6; align-self: flex-end; }
        .message.ai { background-color: #f1f1f1; align-self: flex-start; }
        .unassigned-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(200, 200, 200, 0.7); z-index: 10; display: flex; justify-content: center; align-items: center; font-size: 1.2em; color: #333; backdrop-filter: blur(2px); }
        
        /* --- Styles for Floating/Hideable Input --- */
        .chatarea-input-container { position: absolute; bottom: 0; left: 0; right: 0; padding: 10px; }
        .chatarea-input-container .input-bar { position: absolute; bottom: 10px; right: 15px; display: flex; align-items: center; justify-content: center; cursor: pointer; height: 32px; width: 50px; background-color: rgba(240, 240, 240, 0.8); border-radius: 16px; border: 1px solid #ddd; transition: background-color 0.2s; z-index: 5; }
        .chatarea-input-container .input-bar:hover { background-color: #e9e9e9; }
        .chatarea-input-container textarea { display: none; width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid #ccc; border-radius: 4px; height: 60px; resize: none; }
        .chatarea-input-container.is-active { background-color: #fff; border-top: 1px solid #ddd; }
        .chatarea-input-container.is-active .input-bar { display: none; }
        .chatarea-input-container.is-active textarea { display: block; }
    </style>
</head>
<body>
    <!-- HTML is unchanged -->
    <div class="header">
        <div class="title">Multiple AI Sync Chat</div>
        <div class="layout-buttons">
            <button data-layout="1">1</button>
            <button data-layout="2" class="active">2</button>
            <button data-layout="3">3</button>
            <button data-layout="4">4</button>
            <button data-layout="6">6</button>
        </div>
        <div class="control-buttons">
            <button id="settings-btn" title="Settings">⚙️</button>
            <button id="new-chat-btn" title="New Chat">➕</button>
        </div>
    </div>
    <div class="chat-areas" id="chat-areas-container"></div>
    <div class="main-input">
        <textarea id="main-prompt" placeholder="Send a message to all AIs..."></textarea>
        <button id="send-all-btn">Send</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const chatAreasContainer = document.getElementById('chat-areas-container');
            const newChatBtn = document.getElementById('new-chat-btn');
            const mainPrompt = document.getElementById('main-prompt');
            const sendAllBtn = document.getElementById('send-all-btn');
            const layoutButtons = document.querySelectorAll('.layout-buttons button');

            let chatAreaCounter = 0;
            let currentLayout = 2;

            const aiProviders = ["Kimi", "Gemini", "ChatGPT", "DeepSeek", "Grok", "Tongyi"];
            const aiResponses = ["That's a fascinating question!", "I see. The answer is likely related to swallows.", "I'm not entirely sure, but I can speculate.", "The data points to a clear conclusion: 42.", "Could you provide more context?", "Processing... The implications are vast."];

            function addMessageToDisplay(areaElement, messageText, senderType) {
                const contentArea = areaElement.querySelector('.chatarea-content');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${senderType}`;
                messageDiv.textContent = messageText;
                contentArea.appendChild(messageDiv);
                contentArea.scrollTop = contentArea.scrollHeight;
            }

            function simulateAiResponse(areaElement) {
                if (areaElement.classList.contains('unassigned')) return;
                const areaId = parseInt(areaElement.dataset.aiId, 10);
                const responseText = aiResponses[areaId % aiResponses.length];
                setTimeout(() => addMessageToDisplay(areaElement, responseText, 'ai'), 1000 + Math.random() * 500);
            }

            function broadcastMainMessage() {
                const message = mainPrompt.value.trim();
                if (message) {
                    document.querySelectorAll('.chatarea:not(.unassigned)').forEach(area => {
                        addMessageToDisplay(area, message, 'user');
                        simulateAiResponse(area);
                    });
                    mainPrompt.value = '';
                }
            }

            function handleIndividualSend(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const textarea = e.target;
                    const message = textarea.value.trim();
                    const areaElement = textarea.closest('.chatarea');
                    if (message && areaElement && !areaElement.classList.contains('unassigned')) {
                        addMessageToDisplay(areaElement, message, 'user');
                        simulateAiResponse(areaElement);
                        textarea.value = '';
                    }
                }
            }

            function updateLayoutButtonStates() {
                const count = chatAreasContainer.children.length;
                layoutButtons.forEach(button => {
                    button.disabled = parseInt(button.dataset.layout, 10) < count;
                });
            }

            function updateLayout() {
                const count = chatAreasContainer.children.length;
                if (count === 0) {
                    chatAreasContainer.style.gridTemplateColumns = 'none';
                    updateLayoutButtonStates();
                    return;
                }
                if (parseInt(currentLayout, 10) < count) {
                    currentLayout = count;
                }
                let columns = 1, rows = 1;
                switch (String(currentLayout)) {
                    case '1': columns = 1; break;
                    case '2': columns = 2; break;
                    case '3': columns = 3; break;
                    case '4': columns = 2; rows = 2; break;
                    case '6': columns = 3; rows = 2; break;
                    default: columns = Math.min(count, 2); break;
                }
                chatAreasContainer.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;
                chatAreasContainer.style.gridTemplateRows = rows > 1 ? `repeat(${rows}, 1fr)` : 'none';
                layoutButtons.forEach(b => b.classList.toggle('active', b.dataset.layout === String(currentLayout)));
                updateLayoutButtonStates();
            }

            function attachEventListeners(areaElement) {
                const inputContainer = areaElement.querySelector('.chatarea-input-container');
                const textarea = areaElement.querySelector('textarea');
                const contentArea = areaElement.querySelector('.chatarea-content');

                function activateInput(isActive) {
                    if (isActive) {
                        inputContainer.classList.add('is-active');
                        contentArea.style.paddingBottom = (inputContainer.offsetHeight + 10) + 'px';
                    } else {
                        inputContainer.classList.remove('is-active');
                        contentArea.style.paddingBottom = '15px';
                    }
                }

                inputContainer.addEventListener('mouseenter', () => {
                    if (!areaElement.classList.contains('unassigned')) {
                        activateInput(true);
                    }
                });
                inputContainer.addEventListener('mouseleave', () => {
                    if (document.activeElement !== textarea) {
                        activateInput(false);
                    }
                });
                textarea.addEventListener('focus', () => activateInput(true));
                textarea.addEventListener('blur', () => activateInput(false));

                areaElement.querySelector('.control-close').addEventListener('click', () => {
                    areaElement.remove();
                    updateLayout();
                });
                areaElement.querySelector('.control-share').addEventListener('click', () => console.log(`Share button clicked for ${areaElement.id}`));
                textarea.addEventListener('keydown', handleIndividualSend);
                areaElement.querySelector('.ai-selector').addEventListener('change', (e) => {
                    const selectedAiIndex = e.target.value;
                    if (selectedAiIndex) {
                        const aiName = aiProviders[selectedAiIndex];
                        areaElement.classList.remove('unassigned');
                        areaElement.querySelector('.unassigned-overlay').style.display = 'none';
                        textarea.disabled = false;
                        textarea.placeholder = `Send a message to ${aiName}...`;
                        const selector = e.target;
                        const headerText = document.createElement('span');
                        headerText.textContent = aiName;
                        selector.parentNode.insertBefore(headerText, selector);
                        selector.style.display = 'none';
                        areaElement.dataset.aiId = selectedAiIndex;
                    }
                });
            }

            function createChatArea() {
                chatAreaCounter++;
                const chatAreaId = `chatarea-${chatAreaCounter}`;
                const element = document.createElement('div');
                element.className = 'chatarea unassigned';
                element.id = chatAreaId;
                const aiOptions = aiProviders.map((name, index) => `<option value="${index}">${name}</option>`).join('');
                element.innerHTML = `
                    <div class="chatarea-header">
                        <select class="ai-selector"><option value="">Select AI...</option>${aiOptions}</select>
                        <div>
                            <button class="control-share" title="Share">🔗</button>
                            <button class="control-close" title="Close">❌</button>
                        </div>
                    </div>
                    <div class="chatarea-body">
                        <div class="unassigned-overlay">Select an AI Provider</div>
                        <div class="chatarea-content"></div>
                        <div class="chatarea-input-container">
                            <div class="input-bar"><span>⬆️</span></div>
                            <textarea placeholder="Assign an AI to start..." disabled></textarea>
                        </div>
                    </div>
                `;
                chatAreasContainer.appendChild(element);
                attachEventListeners(element);
                updateLayout();
            }

            // --- Initial Setup ---
            newChatBtn.addEventListener('click', createChatArea);
            sendAllBtn.addEventListener('click', broadcastMainMessage);
            mainPrompt.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); broadcastMainMessage(); } });
            layoutButtons.forEach(button => button.addEventListener('click', () => { currentLayout = button.dataset.layout; updateLayout(); }));

            createChatArea();
            createChatArea();
        });
    </script>

</body>
</html>