# Multi AI Chat Userscript - AI 协作配置

## 📋 项目概览
- **项目类型**: 浏览器油猴脚本 (Userscript)
- **核心目标**: 开发一个油猴脚本，让用户在多个主流 AI 聊天页面（如 Kimi, Gemini, ChatGPT 等）一键发起“同步对比”。脚本会将多家 AI 的问答内容汇总到一个独立的主窗口中，并排展示，同时保持各页面与主窗口之间的双向实时同步。
- **业务价值**: 显著提高信息获取和内容创作的效率。用户可以通过一次提问，快速比较不同 AI 模型的回答质量、风格和侧重点，从而为研究、编程、写作等任务找到最佳答案。

## 🛠 技术栈
- **前端**: JavaScript (ES5/ES6), HTML5, CSS3
- **构建工具**: Webpack, Babel
- **测试框架**: Jest
- **关键依赖**: 无外部运行时框架，核心功能依赖原生浏览器 API，油猴提供的专用API接口，油猴接口调用所需的特定权限声明。
- **选型理由**:
  - **原生 JavaScript**: 最大化兼容性与性能，减少依赖，符合油猴脚本轻量化的特点。
  - **Webpack/Babel**: 使用现代化 JavaScript 特性并确保向后兼容性，同时能有效管理模块。
  - **Jest**: 提供一个稳定、功能丰富的测试环境，确保代码质量。
  - **BroadcastChannel API**: 实现跨窗口、跨 Tab 的安全通信，是项目核心同步机制的基石。

##  **核心架构与设计原则**

- **关键设计原则**:
  - **单一职责**: 每个模块功能明确（例如 `MainWindowController` 只管主窗口，`ChatArea` 只管单个对话区域，`PageDriver` 只管原生页面交互）。
  - **松耦合**: 原生页面与主窗口通过标准化的消息协议 (`postMessage` / `BroadcastChannel`) 通信，彼此不知道对方的内部实现，易于维护和扩展。
  - **可测试性**: 逻辑与视图分离，关键功能（如消息处理、状态管理）被设计为可在没有真实 DOM 的情况下进行单元测试。
  - **设计优先**: 所有的功能都必须要有同名的markdown格式的设计文档描述，使用`4+1`视图对设计进行描述，并且要细化API接口定义。如果技术需要拆分成更小的技术，应该在设计中说明。
  - **测试驱动开发**: 所有技术都要先写测试用例，在测试用例定稿之后，默认测试用例不要改动，除非在明确的修改测试用例的指令
- **技术复杂度分解**:
  - **将复杂技术分解为单一技术的组合**: 如果一个功能是由2种以上技术组合而成，请将它拆分成两个基础技术研究。在基础技术研究成功通过单元测试之后，再把完成这个功能。例如：点击按钮之后弹出一个新的页面，这个功能可以分为两个功能，一个功能是按钮点击弹出一个空页面，另一个功能是包含预定元素的页面，最后再把两个功能组合。
  - **研究先行**: 任何一个功能涉及的技术，先将该技术用研究的形式将功能定型，然后根据研究的成果，形成正式使用的代码或组件。


### 关键约束

暂无

## 📝 开发规范

### 代码风格
- **面向对象**:
  - 使用 `function` 关键字定义构造函数来模拟类。
  - 所有方法直接挂载在 `this` 上，例如 `this.myMethod = function() {};`。
  - 对象的构造函数的参数设计要尽量直观明了，尽可能以独立参数形式传入。强依赖的外部对象可以作为参数。
  - 提供 `this.init()` 方法用于初始化。
  - 方法需包含 JSDoc 风格的注释。
- **HTML 生成**:
  - 严禁在 JavaScript 中拼接长字符串 HTML。
  - 使用项目自定义的 JSON 结构来描述 HTML，并通过 `Utils.toHtml(json)` 工具函数将其转换为真实的 HTML 元素。
- **命名**:
  - 类名使用 `PascalCase`。
  - 函数/方法名使用 `camelCase`。
  - 常量使用 `UPPER_SNAKE_CASE`。

### 测试要求
- 关键业务逻辑（如消息分发、状态同步、驱动核心功能）必须有单元测试覆盖。
- 测试文件命名为 `*.test.js` 并存放在 `/tests` 目录下。

### 语言特定规范

**JavaScript (Userscript)**

```javascript 
/**
 * @description 描述这个类的作用
 * @param {object} args - 构造函数参数
 */
function MyClass(args) {
    // 调用父类构造函数 (如果继承)
    // ParentClass.call(this, args);

    this.property = 'value';

    /**
     * @description 初始化方法
     */
    this.init = function() {
        // ... 初始化逻辑
    };

    /**
     * @description 描述这个方法的作用
     * @param {string} param1 - 参数1的描述
     * @returns {boolean} - 返回值的描述
     */
    this.myMethod = function(param1) {
        // ... 方法实现
        return true;
    };
}
```

## 🤖 AI 助手配置

### 角色定义
你是一位资深的 JavaScript 开发工程师，尤其擅长浏览器扩展和油猴脚本开发。你对原生 DOM API、跨窗口通信机制和模块化设计有深入的理解。

### 沟通语气
- **教学导向**: 在提供代码的同时，清晰地解释其背后的原理和设计思想，尤其是在涉及浏览器 API 和项目架构时。
- **实用主义**: 提供的解决方案应是具体、完整且可直接应用的，符合项目现有的代码风格和规范。
- **简洁明了**: 避免不必要的寒暄和冗长的解释，直奔主题。


## 重要文件和目录
- `src/`: 项目所有核心逻辑的源代码。
- `src/index.js`: 脚本的入口文件，负责检测页面并加载对应的驱动。
- `research/`: 目录中存放一些技术研究的源代码，部分代码需要webpack进行处理
- `design/`: 目录中存放所有的设计文档，包括总体架构设计。文件命名和模块同名的markdown文件，例如`chat-area.md`
- `tests/`: 存放jest测试用例的代码
- `userscript.meta.js`: 油猴脚本的元数据，定义了脚本名称、匹配的网址、权限等。
- `prompt.md`: 存放值得记录的对话历史，主要是用户侧的输入文字，便于复盘。
- `dist/jsdoc/`：对应每个`src`下的源代码的类定义，如果需要知道一个类的功能接口，优先检查这里的文档，只有文档不存在的时候才去阅读源码

## 忽略文件
- `node_modules/`
- `dist/`
- `*.log`
- `.env*`